<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>///textrot studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="fonts.css" rel="stylesheet" />

    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      
      #font-loading-debug {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.95);
        border: 1px solid #333;
        color: #fff;
        border-radius: 8px;
        font-family: monospace;
        font-size: 11px;
        width: 320px;
        height: 400px;
        pointer-events: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        display: none; /* Controlled by React settings */
        flex-direction: column;
      }
      #font-debug-header {
        padding: 12px 15px;
        font-weight: bold;
        border-bottom: 1px solid #444;
        background: rgba(0,0,0,0.2);
        border-radius: 8px 8px 0 0;
        flex-shrink: 0;
        letter-spacing: 0.5px;
      }
      #font-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
      }
      #font-debug-footer {
        padding: 10px 15px;
        border-top: 1px solid #444;
        background: rgba(0,0,0,0.2);
        border-radius: 0 0 8px 8px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #recheck-fonts-btn {
        flex: 1;
        background: #333;
        border: 1px solid #555;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      #recheck-fonts-btn:hover { background: #444; }
      #font-loaded-count {
        font-size: 10px;
        color: #888;
        font-weight: bold;
        min-width: 40px;
        text-align: right;
      }

      .font-status-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
        padding: 2px 4px;
        border-radius: 2px;
        cursor: pointer;
        user-select: none;
      }
      .font-status-row:hover {
        background: rgba(255,255,255,0.1);
      }
      .font-status-loaded { color: #4ade80; font-weight: bold; }
      .font-status-failed { color: #f87171; font-weight: bold; }
      .font-status-pending { color: #fbbf24; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-neutral-950 text-white antialiased overflow-hidden">
    <div id="root"></div>
    <div id="font-loading-debug">
        <div id="font-debug-header">FONT DIAGNOSTICS</div>
        <div id="font-list"></div>
        <div id="font-debug-footer">
            <button id="recheck-fonts-btn">Re-Check Status</button>
            <span id="font-loaded-count">0/0</span>
        </div>
    </div>
    <script>
        (function() {
            const container = document.getElementById('font-list');
            const countLabel = document.getElementById('font-loaded-count');
            const recheckBtn = document.getElementById('recheck-fonts-btn');

            function extractFamilies(textOrUrl) {
                const families = [];
                const regex = /family=([^&:]+)/g;
                let match;
                while ((match = regex.exec(textOrUrl)) !== null) {
                    const name = decodeURIComponent(match[1].replace(/\+/g, ' '));
                    families.push(name);
                }
                return families;
            }

            async function getFontList() {
                const families = new Set();
                let success = false;

                // Strategy 1: Check document.styleSheets (Preferred)
                try {
                    const sheet = Array.from(document.styleSheets).find(s => s.href && s.href.includes('fonts.css'));
                    if (sheet) {
                        try {
                            const rules = sheet.cssRules;
                            for (let i = 0; i < rules.length; i++) {
                                const rule = rules[i];
                                if (rule.constructor.name === 'CSSImportRule' || rule.type === 3) {
                                    extractFamilies(rule.href).forEach(f => families.add(f));
                                }
                            }
                            success = true;
                        } catch (e) {
                            console.warn("Access to cssRules blocked:", e);
                        }
                    }
                } catch(e) {
                    console.warn("Stylesheet strategy failed:", e);
                }

                // Strategy 2: Fetch fonts.css (Fallback)
                if (!success || families.size === 0) {
                    try {
                        const response = await fetch('fonts.css');
                        if (response.ok) {
                            const css = await response.text();
                            // Look for @import url('...')
                            const importRegex = /@import\s+url\(['"]?([^'"]+)['"]?\)/g;
                            let match;
                            while ((match = importRegex.exec(css)) !== null) {
                                extractFamilies(match[1]).forEach(f => families.add(f));
                            }
                            success = true;
                        } else {
                            console.warn("Fetch returned status:", response.status);
                        }
                    } catch(e) {
                        // Suppress "Failed to fetch" to console if possible, just log warn
                        console.warn("Fetch strategy failed (likely local env restrictions):", e);
                    }
                }

                return Array.from(families).sort();
            }

            async function init() {
                container.innerHTML = '<div style="opacity:0.6; padding: 10px;">Analyzing fonts...</div>';
                
                try {
                    const families = await getFontList();
                    
                    if (families.length === 0) {
                         container.innerHTML = '<div style="padding:10px; color:#fbbf24; font-size:10px;">Font list unavailable.<br/>(CSS access restricted in this environment)<br/><br/>Fonts should still load correctly in the canvas.</div>';
                         countLabel.textContent = "-/-";
                         return;
                    }

                    container.innerHTML = '';
                    countLabel.textContent = `0/${families.length}`;

                    // Create Rows
                    families.forEach(font => {
                        const row = document.createElement('div');
                        row.className = 'font-status-row';
                        const safeName = font.replace(/[^a-zA-Z0-9]/g, '-');
                        row.innerHTML = `<span>${font}</span><span id="status-${safeName}" class="font-status-pending">Wait</span>`;
                        row.title = "Double-click to force load";
                        
                        row.addEventListener('dblclick', () => {
                             const span = document.createElement('span');
                             span.style.fontFamily = `"${font}"`;
                             span.textContent = 'LoadTrigger';
                             span.style.position = 'absolute';
                             span.style.opacity = '0';
                             span.style.pointerEvents = 'none';
                             document.body.appendChild(span);
                             setTimeout(() => document.body.removeChild(span), 100);
                             checkFonts(families);
                             window.dispatchEvent(new CustomEvent('textrot-open-font', { detail: font }));
                        });
                        container.appendChild(row);
                    });

                    checkFonts(families);
                    
                    let checks = 0;
                    const interval = setInterval(() => {
                        checkFonts(families);
                        checks++;
                        if (checks > 10) clearInterval(interval);
                    }, 1000);

                    recheckBtn.onclick = () => checkFonts(families);
                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div style="padding:10px; color:#f87171">Diagnostics Error</div>`;
                }
            }

            async function checkFonts(families) {
                await document.fonts.ready;
                let loaded = 0;
                families.forEach(font => {
                    const safeName = font.replace(/[^a-zA-Z0-9]/g, '-');
                    const el = document.getElementById(`status-${safeName}`);
                    if (el) {
                        if (document.fonts.check(`12px "${font}"`)) {
                            el.textContent = 'OK';
                            el.className = 'font-status-loaded';
                            loaded++;
                        } else {
                            el.textContent = '...';
                            el.className = 'font-status-pending';
                        }
                    }
                });
                countLabel.textContent = `${loaded}/${families.length}`;
            }

            // Delay init slightly to ensure stylesheets are registered
            if (document.readyState === 'complete') {
                init();
            } else {
                window.addEventListener('load', init);
            }
        })();
    </script>
  </body>
</html>